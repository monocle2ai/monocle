name: Run Monocle Unit and Integration Tests

on:
  push:
    branches:
      - "main"
  pull_request:
    branches:
      - "main"
  workflow_dispatch:

jobs:
  Unit-Integration-Test:
    runs-on: ubuntu-latest
    environment: Stage
    env:
      AZURE_OPENAI_API_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_API_DEPLOYMENT }}
      AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
      AZURE_OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION }}
      AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      AWS_ACCESS_KEY_BOTO: ${{ secrets.AWS_ACCESS_KEY_BOTO }}
      AWS_ACCESS_KEY_ID_EXPORTER: ${{ secrets.AWS_ACCESS_KEY_ID_EXPORTER }}
      AWS_SECRET_ACCESS_KEY_BOTO: ${{ secrets.AWS_SECRET_ACCESS_KEY_BOTO }}
      AWS_SECRET_ACCESS_KEY_EXPORTER: ${{ secrets.AWS_SECRET_ACCESS_KEY_EXPORTER }}
      AZURE_AI_CHAT_ENDPOINT: ${{ secrets.AZURE_AI_CHAT_ENDPOINT }}
      AZURE_AI_CHAT_KEY: ${{ secrets.AZURE_AI_CHAT_KEY }}
      AZURE_API_BASE: ${{ secrets.AZURE_API_BASE }}
      AZURE_API_KEY: ${{ secrets.AZURE_API_KEY }}
      AZURE_API_VERSION: ${{ secrets.AZURE_API_VERSION }}
      AZURE_OPENAI_EMBED_API_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_EMBED_API_DEPLOYMENT }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
      HAYSTACK_AUTO_TRACE_ENABLED: ${{ secrets.HAYSTACK_AUTO_TRACE_ENABLED }}
      MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
      MONOCLE_AWS_SECRET_ACCESS_KEY: ${{ secrets.MONOCLE_AWS_SECRET_ACCESS_KEY }}
      MONOCLE_BLOB_CONNECTION_STRING: ${{ secrets.MONOCLE_BLOB_CONNECTION_STRING }}
      MONOCLE_BLOB_CONTAINER_NAME: ${{ secrets.MONOCLE_BLOB_CONTAINER_NAME }}
      MONOCLE_REGION_NAME: ${{ secrets.MONOCLE_REGION_NAME }}
      MONOCLE_S3_BUCKET_NAME: ${{ secrets.MONOCLE_S3_BUCKET_NAME }}
      MONOCLE_S3_REGION_NAME: ${{ secrets.MONOCLE_S3_REGION_NAME }}
      MONOCLE_TRACE_PROPAGATATION_URLS: ${{ secrets.MONOCLE_TRACE_PROPAGATATION_URLS }}
      OPENSEARCH_ENDPOINT_URL: ${{ secrets.OPENSEARCH_ENDPOINT_URL }}
      OPENSEARCH_ENDPOINT_URL_BOTO: ${{ secrets.OPENSEARCH_ENDPOINT_URL_BOTO }}
      OPEN_SEARCH_AUTH_PASSWORD: ${{ secrets.OPEN_SEARCH_AUTH_PASSWORD }}
      OPEN_SEARCH_AUTH_USER: ${{ secrets.OPEN_SEARCH_AUTH_USER }}
      OPEN_SEARCH_DOCSTORE_ENDPOINT: ${{ secrets.OPEN_SEARCH_DOCSTORE_ENDPOINT }}
      SAGEMAKER_EMB_ENDPOINT_NAME: ${{ secrets.SAGEMAKER_EMB_ENDPOINT_NAME }}
      SAGEMAKER_ENDPOINT_NAME: ${{ secrets.SAGEMAKER_ENDPOINT_NAME }}
      _CLOUD_SDK_MISSING_CREDENTIALS: ${{ secrets._CLOUD_SDK_MISSING_CREDENTIALS }}
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      BEDROCK_MODEL: ${{ secrets.BEDROCK_MODEL }}
      ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
      HUGGING_FACE_API_KEY: ${{ secrets.HUGGING_FACE_API_KEY }}
      DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
      GCP_REGION: ${{ secrets.GCP_REGION }}
      VERTEX_AI_API_KEY: ${{ secrets.VERTEX_AI_API_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # - name: Export env vars from secret JSON
      #   env:
      #     INTEGRATION_TEST_CONFIG: ${{ secrets.INTEGRATION_TEST_CONFIG }}
        # run: |
        #   echo "$INTEGRATION_TEST_CONFIG" > env.json
        #   python <<EOF
        #   import json, os
        #   with open('env.json') as f:
        #       envs = json.load(f)
        #   with open(os.environ['GITHUB_ENV'], 'a') as env_file:
        #       for k, v in envs.items():
        #           print(f'::add-mask::{v}')  # mask secret values in logs
        #           env_file.write(f'{k}={v}\n')

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build setuptools wheel toml

      - name: Build wheels
        run: |
          chmod +x ./.github/scripts/build-all.sh
          ./.github/scripts/build-all.sh

      - name: Install package and dev dependencies
        run: |
          pip install --upgrade pip
          cd apptrace
          pip install -e '.[dev]'
          pip install -e '.[azure]'
          pip install -e '.[aws]'

      - name: Run Unit tests
        id: run-unit-tests
        run: |
          cd apptrace
          export PYTHONPATH=./src:./tests
          set -e
          pytest -rfs tests/unit/test*.py --tb=short | tee unitresult.log
          EXIT_CODE=${PIPESTATUS[0]}
          grep -E 'FAILED.*::' unitresult.log | cut -d ':' -f 1 | sort | uniq > unitfailed_files.txt
          echo "" >> failed_files.txt
          echo "Failed unit test files:"
          echo "Failed unit test files:" >> failed_files.txt
          cat ./unitfailed_files.txt
          cat ./unitfailed_files.txt >> failed_files.txt
          echo "" >> failed_files.txt
          LINE_NUM=$(grep -nE "===== .*((failed|passed|skipped|warnings).*)+ in .* ======" unitresult.log | tail -1 | cut -d: -f1)
          tail -n +$LINE_NUM ./unitresult.log > unittest_summary.txt
          echo "" >> test_summary.txt
          echo "Unit Test Summary:" >> test_summary.txt
          cat ./unittest_summary.txt >> test_summary.txt
          echo "" >> test_summary.txt
          exit $EXIT_CODE

      
      - name: Add Test Summary to Summary (Table)
        if: always()
        run: |
          cd apptrace
          if [[ -s ./unittest_summary.txt ]]; then
            {
              echo "### Unit Test Summary"
              echo ""
              echo "| Unit Test Summary |"
              echo "|--------------------|"
              while read -r file; do
                echo "| $file |"
              done < unittest_summary.txt
            } >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Add Failed Files to Summary (Table)
        if: always()
        run: |
          cd apptrace
          if [[ -s ./unitfailed_files.txt ]]; then
            {
              echo "### ❌ Failed Unit Test Files"
              echo ""
              echo "| Failed Unit Test File Path |"
              echo "|-----------------------------|"
              while read -r file; do
                echo "| $file |"
              done < unitfailed_files.txt
            } >> $GITHUB_STEP_SUMMARY
          else
            echo "### ✅ All unit and integration tests passed!" >> $GITHUB_STEP_SUMMARY
          fi

      
      - name: Run Integration tests
        if: always()
        id: run-integration-tests
        run: |
          cd apptrace
          export PYTHONPATH=./src:./tests
          set -e
          pytest -rfs tests/integration/test*.py --tb=short | tee integration_test_result.log
          EXIT_CODE=${PIPESTATUS[0]}
          grep -E 'FAILED.*::' integration_test_result.log | cut -d ':' -f 1 | sort | uniq >> integrationtest_failed_files.txt
          echo "Failed Integration test files:"
          echo "" >> failed_files.txt
          echo "Failed Integration test files:" >> failed_files.txt
          cat ./integrationtest_failed_files.txt
          cat ./integrationtest_failed_files.txt >> failed_files.txt
          echo "" >> failed_files.txt
          LINE_NUM=$(grep -nE "= .*((failed|passed|skipped|warnings).*)+ in .* =" integration_test_result.log | tail -1 | cut -d: -f1)
          tail -n +$LINE_NUM ./integration_test_result.log >> integration_test_summary.txt
          echo "" >> integration_test_summary.txt
          echo "Integration Test Summary:" >> test_summary.txt
          cat ./integration_test_summary.txt >> test_summary.txt
          echo "" >> integration_test_summary.txt
          exit $EXIT_CODE

      - name: Add Test Summary to Summary (Table)
        if: always()
        run: |
          cd apptrace
          if [[ -s ./integration_test_summary.txt ]]; then
            {
              echo "### Integration Test Summary"
              echo ""
              echo "| Integration Test Summary |"
              echo "|---------------------------|"
              while read -r file; do
                echo "| $file |"
              done < integration_test_summary.txt
            } >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Add Failed Files to Summary (Table)
        if: always()
        run: |
          cd apptrace
          if [[ -s ./integrationtest_failed_files.txt ]]; then
            {
              echo "### ❌ Integration Failed Test Files"
              echo ""
              echo "| Integration Test Failed File Path |"
              echo "|-----------------------------|"
              while read -r file; do
                echo "| $file |"
              done < integrationtest_failed_files.txt
            } >> $GITHUB_STEP_SUMMARY
          else
            echo "### ✅ All unit and integration tests passed!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Prepare email content
        if: always()
        run: |
          cp apptrace/failed_files.txt ./
          cp apptrace/test_summary.txt ./
          
          # Determine test status
          if [[ -s ./failed_files.txt ]]; then
            echo "TEST_STATUS=FAILED" >> $GITHUB_ENV
            echo "EMAIL_SUBJECT=❌ Monocle Unit and Integration Tests FAILED - ${{ github.ref_name }}" >> $GITHUB_ENV
          else
            echo "TEST_STATUS=PASSED" >> $GITHUB_ENV
            echo "EMAIL_SUBJECT=✅ Monocle Unit and Integration Tests PASSED - ${{ github.ref_name }}" >> $GITHUB_ENV
          fi
          
          # Create email body
          cat > email_body.txt << 'EOF'
          Monocle Unit and Integration Test Results
          
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Workflow: ${{ github.workflow }}
          Run ID: ${{ github.run_id }}
          Triggered by: ${{ github.actor }}
          Event: ${{ github.event_name }}
          
          View full results: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          EOF
          
          # Add test summary
          if [[ -s ./test_summary.txt ]]; then
            echo "Test Summary:" >> email_body.txt
            cat ./test_summary.txt >> email_body.txt
            echo "" >> email_body.txt
          fi
          
          # Add failed files if any
          if [[ -s ./failed_files.txt ]]; then
            echo "Failed Test Files:" >> email_body.txt
            cat ./failed_files.txt >> email_body.txt
            echo "" >> email_body.txt
          fi

          #echo "Attachments: Full test log (result.log)" >> email_body.txt
  
      - name: Send Email Notification
        if: always()
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.OKAHUGMAIL_USERNAME }}
          password: ${{ secrets.OKAHUGMAIL_APP_PASSWORD }}
          subject: Monocle Integration Test Results
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          body: file://email_body.txt
          attachments: test_summary.txt,failed_files.txt
